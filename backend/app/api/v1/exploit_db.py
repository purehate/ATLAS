"""
Exploit-DB RSS feed API endpoint
Fetches and parses the Exploit-DB RSS feed
"""
from fastapi import APIRouter, HTTPException
from fastapi.responses import JSONResponse
import httpx
from bs4 import BeautifulSoup
from typing import List, Dict
from app.utils.logging import setup_logging

logger = setup_logging()

router = APIRouter()

EXPLOIT_DB_RSS_URL = "https://www.exploit-db.com/rss.xml"


@router.get("/exploit-db/feed")
async def get_exploit_db_feed():
    """
    Fetch and parse Exploit-DB RSS feed
    Returns recent exploits from Exploit-DB
    """
    try:
        async with httpx.AsyncClient(timeout=15.0, follow_redirects=True) as client:
            response = await client.get(EXPLOIT_DB_RSS_URL)
            response.raise_for_status()
            
            # Parse RSS XML
            soup = BeautifulSoup(response.text, "xml")
            items = soup.find_all("item")
            
            exploits = []
            for item in items[:20]:  # Limit to 20 most recent
                title_elem = item.find("title")
                link_elem = item.find("link")
                pub_date_elem = item.find("pubDate")
                description_elem = item.find("description")
                
                if title_elem and link_elem:
                    exploit = {
                        "title": title_elem.text.strip() if title_elem.text else "",
                        "link": link_elem.text.strip() if link_elem.text else "",
                        "pubDate": pub_date_elem.text.strip() if pub_date_elem and pub_date_elem.text else "",
                        "description": description_elem.text.strip() if description_elem and description_elem.text else "",
                    }
                    exploits.append(exploit)
            
            return JSONResponse(content={
                "items": exploits,
                "count": len(exploits),
                "source": "Exploit-DB RSS Feed"
            })
            
    except httpx.HTTPError as e:
        logger.error(f"Failed to fetch Exploit-DB RSS: {e}")
        raise HTTPException(status_code=503, detail=f"Failed to fetch Exploit-DB feed: {str(e)}")
    except Exception as e:
        logger.error(f"Error parsing Exploit-DB RSS: {e}")
        raise HTTPException(status_code=500, detail=f"Error parsing feed: {str(e)}")
