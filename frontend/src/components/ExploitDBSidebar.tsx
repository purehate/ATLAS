import { useState, useEffect } from 'react';

interface ExploitItem {
  title: string;
  link: string;
  pubDate: string;
  description: string;
  guid?: string;
}

export default function ExploitDBSidebar() {
  const [isOpen, setIsOpen] = useState(false);
  const [exploits, setExploits] = useState<ExploitItem[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (isOpen && exploits.length === 0) {
      loadExploits();
    }
  }, [isOpen]);

  const loadExploits = async () => {
    setLoading(true);
    setError(null);
    
    try {
      // Fetch RSS feed - need to use a proxy or CORS-friendly approach
      // Since RSS feeds often have CORS issues, we'll fetch via our backend
      const response = await fetch(`${window.location.protocol}//${window.location.hostname}:6768/api/v1/exploit-db/feed`);
      
      if (!response.ok) {
        throw new Error('Failed to fetch Exploit-DB feed');
      }
      
      const data = await response.json();
      setExploits(data.items || []);
    } catch (err: any) {
      console.error('Failed to load Exploit-DB feed:', err);
      setError(err.message || 'Failed to load exploits');
    } finally {
      setLoading(false);
    }
  };

  return (
    <>
      {/* Toggle Button */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="fixed right-4 top-4 z-50 hacker-button text-sm font-hacker px-3 py-2"
        aria-label="Toggle Exploit-DB feed"
      >
        {isOpen ? 'Exploits >' : '< Exploits'}
      </button>

      {/* Sidebar */}
      <div
        className={`fixed right-0 top-0 h-full bg-gruvbox-dark border-l-2 border-gruvbox-green-bright z-40 transition-transform duration-300 shadow-lg ${
          isOpen ? 'translate-x-0' : 'translate-x-full'
        }`}
        style={{ width: '400px', maxWidth: '90vw' }}
      >
        <div className="p-4 h-full flex flex-col">
          {/* Header */}
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold text-gruvbox-green-bright glow-text font-hacker">
              {'>'} Exploit-DB Feed
            </h2>
            <button
              onClick={() => setIsOpen(false)}
              className="text-gruvbox-gray hover:text-gruvbox-light font-mono"
            >
              ×
            </button>
          </div>

          {/* Refresh Button */}
          <button
            onClick={loadExploits}
            disabled={loading}
            className="mb-4 text-sm text-gruvbox-blue hover:text-gruvbox-blue-bright font-mono disabled:opacity-50"
          >
            {loading ? 'Loading...' : '↻ Refresh'}
          </button>

          {/* Content */}
          <div className="flex-1 overflow-y-auto">
            {loading && exploits.length === 0 ? (
              <div className="text-gruvbox-gray text-sm font-mono text-center py-8">
                Loading exploits...
              </div>
            ) : error ? (
              <div className="text-gruvbox-red text-sm font-mono text-center py-8">
                {error}
              </div>
            ) : exploits.length === 0 ? (
              <div className="text-gruvbox-gray text-sm font-mono text-center py-8">
                No exploits loaded.
                <br />
                Click refresh to load.
              </div>
            ) : (
              <div className="space-y-3">
                {exploits.map((exploit, idx) => (
                  <div
                    key={idx}
                    className="terminal-card rounded p-3 border border-gruvbox-bg0 hover:border-gruvbox-green-bright transition-colors"
                  >
                    <a
                      href={exploit.link}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="font-semibold text-gruvbox-blue-bright hover:text-gruvbox-blue hover:underline block mb-2 text-sm"
                    >
                      {exploit.title}
                    </a>
                    <div className="text-xs text-gruvbox-gray font-mono mb-2">
                      {new Date(exploit.pubDate).toLocaleDateString()}
                    </div>
                    {exploit.description && (
                      <div className="text-xs text-gruvbox-light font-mono line-clamp-3 opacity-90">
                        {exploit.description.replace(/<[^>]*>/g, '').substring(0, 150)}...
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Footer */}
          <div className="text-xs text-gruvbox-gray font-mono mt-4 pt-4 border-t border-gruvbox-bg0 text-center">
            <a
              href="https://www.exploit-db.com"
              target="_blank"
              rel="noopener noreferrer"
              className="text-gruvbox-blue-bright hover:underline"
            >
              exploit-db.com
            </a>
          </div>
        </div>
      </div>

      {/* Overlay */}
      {isOpen && (
        <div
          onClick={() => setIsOpen(false)}
          className="fixed inset-0 bg-black bg-opacity-50 z-30"
        />
      )}
    </>
  );
}
